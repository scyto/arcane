# syntax=docker/dockerfile:1
# CI packaging only â€” Go binary is pre-compiled on the host runner.
# Expects:
#   dist/arcane-agent-linux-amd64   (built with CGO_ENABLED=0 GOOS=linux GOARCH=amd64 -tags exclude_frontend)
#   dist/arcane-agent-linux-arm64   (built with CGO_ENABLED=0 GOOS=linux GOARCH=arm64 -tags exclude_frontend)

FROM debian:trixie-slim
ARG TARGETARCH

RUN apt-get update \
    && apt-get install -y --no-install-recommends ca-certificates curl tzdata tar gzip \
    vainfo clinfo libdrm2 libsystemd0 \
    && if [ "$TARGETARCH" = "amd64" ]; then \
        apt-get install -y --no-install-recommends intel-gpu-tools; \
    fi \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

ENV NVIDIA_VISIBLE_DEVICES=all \
    NVIDIA_DRIVER_CAPABILITIES=compute,utility \
    ROCR_VISIBLE_DEVICES=all \
    HIP_VISIBLE_DEVICES=all \
    ONEAPI_DEVICE_SELECTOR=level_zero:*,opencl:* \
    LD_LIBRARY_PATH=/usr/local/nvidia/lib:/usr/local/nvidia/lib64:/opt/rocm/lib:/opt/intel/oneapi/lib:/opt/intel/oneapi/lib/intel64:/usr/lib/x86_64-linux-gnu:/usr/lib/aarch64-linux-gnu:/usr/lib64:/usr/lib:/lib64:/lib

ENV ENVIRONMENT=production \
    AGENT_MODE=true \
    GIN_MODE=release \
    PORT=3553

WORKDIR /app
RUN mkdir -p /app/data
COPY dist/arcane-agent-linux-${TARGETARCH} ./arcane-agent
EXPOSE 3553
VOLUME ["/app/data"]

LABEL com.getarcaneapp.arcane.agent="true"

CMD ["./arcane-agent"]
