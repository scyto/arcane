package services

import (
	"context"
	"encoding/json"
	"errors"
	"fmt"
	"io"
	"net"
	"os"
	"testing"

	containertypes "github.com/docker/docker/api/types/container"
	"github.com/getarcaneapp/arcane/backend/internal/models"
	"github.com/getarcaneapp/arcane/types/vulnerability"
	"github.com/stretchr/testify/require"
)

func TestIsExpectedDockerStreamEndErrorInternal(t *testing.T) {
	tests := []struct {
		name string
		err  error
		want bool
	}{
		{name: "nil", err: nil, want: false},
		{name: "eof", err: io.EOF, want: true},
		{name: "wrapped eof", err: fmt.Errorf("wrapped: %w", io.EOF), want: true},
		{name: "net err closed", err: net.ErrClosed, want: true},
		{name: "closed network connection", err: errors.New("read tcp 127.0.0.1:1234->127.0.0.1:5678: use of closed network connection"), want: true},
		{name: "broken pipe", err: errors.New("write: broken pipe"), want: true},
		{name: "connection reset by peer", err: errors.New("read: connection reset by peer"), want: true},
		{name: "unexpected", err: errors.New("some other error"), want: false},
	}

	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			require.Equal(t, tt.want, isExpectedDockerStreamEndErrorInternal(tt.err))
		})
	}
}

func TestDecodeTrivyReportFromFileInternal_LargePayload(t *testing.T) {
	tmpFile, err := os.CreateTemp("", "trivy-report-*.json")
	require.NoError(t, err)
	defer func() {
		require.NoError(t, os.Remove(tmpFile.Name()))
	}()
	defer func() {
		require.NoError(t, tmpFile.Close())
	}()

	const vulnCount = 4000
	vulns := make([]vulnerability.TrivyVulnerability, 0, vulnCount)
	for i := range vulnCount {
		vulns = append(vulns, vulnerability.TrivyVulnerability{
			VulnerabilityID:  fmt.Sprintf("CVE-2026-%04d", i),
			PkgName:          fmt.Sprintf("pkg-%d", i),
			InstalledVersion: "1.0.0",
			FixedVersion:     "1.0.1",
			Severity:         "HIGH",
		})
	}

	report := vulnerability.TrivyReport{
		SchemaVersion: 2,
		ArtifactName:  "example/image:latest",
		ArtifactType:  "container_image",
		Results: []vulnerability.TrivyResults{
			{
				Target:          "alpine:3.20",
				Class:           "os-pkgs",
				Type:            "alpine",
				Vulnerabilities: vulns,
			},
		},
	}

	encoder := json.NewEncoder(tmpFile)
	require.NoError(t, encoder.Encode(report))

	decoded, err := decodeTrivyReportFromFileInternal(tmpFile)
	require.NoError(t, err)
	require.NotNil(t, decoded)
	require.Equal(t, report.ArtifactName, decoded.ArtifactName)
	require.Len(t, decoded.Results, 1)
	require.Len(t, decoded.Results[0].Vulnerabilities, vulnCount)
}

func TestCleanupTrivyLogTempFilesInternal_RemovesFiles(t *testing.T) {
	stdoutFile, err := os.CreateTemp("", "trivy-stdout-test-*")
	require.NoError(t, err)
	stderrFile, err := os.CreateTemp("", "trivy-stderr-test-*")
	require.NoError(t, err)

	stdoutPath := stdoutFile.Name()
	stderrPath := stderrFile.Name()

	_, err = stdoutFile.WriteString("stdout")
	require.NoError(t, err)
	_, err = stderrFile.WriteString("stderr")
	require.NoError(t, err)

	cleanupTrivyLogTempFilesInternal(context.Background(), stdoutFile, stderrFile)

	_, err = os.Stat(stdoutPath)
	require.Error(t, err)
	require.True(t, os.IsNotExist(err))

	_, err = os.Stat(stderrPath)
	require.Error(t, err)
	require.True(t, os.IsNotExist(err))
}

func TestBuildTrivyContainerResourcesInternal_Defaults(t *testing.T) {
	resources, applyLimits := buildTrivyContainerResourcesInternal(nil)

	require.True(t, applyLimits)
	require.Equal(t, int64(1_000_000_000), resources.NanoCPUs)
	require.Equal(t, int64(0), resources.Memory)
	require.Equal(t, int64(0), resources.MemorySwap)
}

func TestBuildTrivyContainerResourcesInternal_LimitsDisabled(t *testing.T) {
	cfg := &models.Settings{
		TrivyResourceLimitsEnabled: models.SettingVariable{Value: "false"},
		TrivyCpuLimit:              models.SettingVariable{Value: "2"},
		TrivyMemoryLimitMb:         models.SettingVariable{Value: "2048"},
	}

	resources, applyLimits := buildTrivyContainerResourcesInternal(cfg)

	require.False(t, applyLimits)
	require.Equal(t, int64(0), resources.NanoCPUs)
	require.Equal(t, int64(0), resources.Memory)
	require.Equal(t, int64(0), resources.MemorySwap)
}

func TestBuildTrivyContainerResourcesInternal_CustomLimits(t *testing.T) {
	cfg := &models.Settings{
		TrivyResourceLimitsEnabled: models.SettingVariable{Value: "true"},
		TrivyCpuLimit:              models.SettingVariable{Value: "2.5"},
		TrivyMemoryLimitMb:         models.SettingVariable{Value: "2048"},
	}

	resources, applyLimits := buildTrivyContainerResourcesInternal(cfg)

	require.True(t, applyLimits)
	require.Equal(t, int64(2_500_000_000), resources.NanoCPUs)
	require.Equal(t, int64(2_147_483_648), resources.Memory)
	require.Equal(t, int64(2_147_483_648), resources.MemorySwap)
}

func TestBuildTrivyHostConfig_ExcludesResourcesWhenLimitsDisabled(t *testing.T) {
	resources := containertypes.Resources{
		NanoCPUs:   int64(2_000_000_000),
		Memory:     int64(1_073_741_824),
		MemorySwap: int64(1_073_741_824),
	}

	hostConfig := buildTrivyHostConfig("cache-volume", nil, resources, false)
	require.Equal(t, int64(0), hostConfig.Resources.NanoCPUs)
	require.Equal(t, int64(0), hostConfig.Resources.Memory)
	require.Equal(t, int64(0), hostConfig.Resources.MemorySwap)
}

func TestBuildTrivyHostConfig_IncludesResourcesWhenLimitsEnabled(t *testing.T) {
	resources := containertypes.Resources{
		NanoCPUs:   int64(2_000_000_000),
		Memory:     int64(1_073_741_824),
		MemorySwap: int64(1_073_741_824),
	}

	hostConfig := buildTrivyHostConfig("cache-volume", nil, resources, true)
	require.Equal(t, resources.NanoCPUs, hostConfig.Resources.NanoCPUs)
	require.Equal(t, resources.Memory, hostConfig.Resources.Memory)
	require.Equal(t, resources.MemorySwap, hostConfig.Resources.MemorySwap)
}
